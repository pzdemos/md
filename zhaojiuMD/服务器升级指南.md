ecs.g6e.xlarge **4** 核（vCPU）**16** GiB
↓
esc.g9i.xlarge  **4** 核（vCPU）**16** GiB

# MongoDB 隐藏节点变配前准备步骤清单

## 一、变配前准备（当前环境操作）

mongodb 隐节点挂载额外的磁盘

### 1. 备份关键配置

```bash
# 备份 fstab
sudo cp /etc/fstab /etc/fstab.backup.$(date +%Y%m%d_%H%M%S)

# 备份 MongoDB 配置
sudo cp /etc/mongod2.conf /etc/mongod2.conf.backup

# 记录当前状态
df -h > /tmp/disk_status_before.txt
mount > /tmp/mount_status_before.txt
lsblk -f > /tmp/lsblk_before.txt
```

### 2. 确认 MongoDB 状态健康

```bash
# 检查隐藏节点运行状态
ps aux | grep mongod2.conf

# 检查数据目录
ls -la /mnt/data/mongodb/
df -h /mnt/data

# 检查复制集状态（需要管理员密码）
mongo --port 40001 -u admin -p --authenticationDatabase admin --eval "rs.status()"
```

### 3. 修改 /etc/fstab（核心步骤）

```bash
# 编辑 fstab
sudo vi /etc/fstab
```

**将：**

```
/dev/vdb /mnt/data ext4 defaults 0 2
```

**改为：**

```
UUID=49495ad6-4317-4a13-9ff9-80482b9d4cb3 /mnt/data ext4 defaults 0 2
```

**完整的 fstab 内容应为：**

```
UUID=7c362a2d-b301-4957-bc3f-a47cd00d822f /          ext4    defaults        1 1
UUID=49495ad6-4317-4a13-9ff9-80482b9d4cb3 /mnt/data ext4    defaults        0 2
```

### 4. 验证 fstab 配置正确

```bash
# 检查语法错误
sudo findmnt --verify

# 确认修改内容
cat /etc/fstab | grep -v "^#"

# 模拟测试（不会实际执行）
sudo mount -fav
```

### 5. 确认备份和复制集状态

```bash
# 确认有近期备份（根据实际路径调整）
ls -lh /backup/mongodb/

# 确认复制集其他节点健康
mongo --host <主节点IP>:<端口> -u admin -p --eval "rs.status()"
```

---

## 二、执行变配（云平台操作）

1. 在云平台控制台选择新规格
2. 确认变配时间窗口
3. 执行变配操作
4. 等待实例重启完成

---

## 三、变配后验证（必须执行）

### 1. 检查磁盘挂载（最优先）

```bash
# 查看挂载状态
df -h /mnt/data

# 查看设备变化（应该看到 nvme 开头的设备）
lsblk -f

# 查看实际挂载情况
mount | grep /mnt/data
```

### 2. 验证数据完整性

```bash
# 检查数据目录
ls -la /mnt/data/mongodb/

# 检查数据大小（对比变配前记录）
du -sh /mnt/data/mongodb/

# 检查文件权限
ls -ld /mnt/data/mongodb/
```

### 3. 检查 MongoDB 状态

```bash
# 查看进程是否运行
ps aux | grep mongod

# 如果进程不存在，手动启动
mongod -f /etc/mongod2.conf

# 检查日志
tail -100 /mnt/data/mongodb/mongod.log
```

### 4. 验证数据库可访问

```bash
# 连接数据库测试
mongo --port 40001 -u admin -p --authenticationDatabase admin --eval "db.serverStatus()"

# 检查复制集状态
mongo --port 40001 -u admin -p --authenticationDatabase admin --eval "rs.status()"
```

### 5. 对比变配前后状态

```bash
# 对比磁盘状态
diff /tmp/disk_status_before.txt <(df -h)

# 对比挂载状态
diff /tmp/mount_status_before.txt <(mount)
```

---

## 四、应急处理（如果挂载失败）

```bash
# 1. 查看新设备名
lsblk

# 2. 手动挂载（假设新设备为 nvme1n1）
sudo mount /dev/nvme1n1 /mnt/data

# 或使用 UUID 挂载
sudo mount UUID=49495ad6-4317-4a13-9ff9-80482b9d4cb3 /mnt/data

# 3. 验证挂载成功
df -h /mnt/data
ls -la /mnt/data/mongodb/

# 4. 启动 MongoDB
mongod -f /etc/mongod2.conf

# 5. 检查并修正 fstab（如果之前改错了）
sudo vi /etc/fstab
```

---

## 五、完成确认清单

- [ ] fstab 已修改为使用 UUID
- [ ] fstab 配置已验证无误
- [ ] 关键配置已备份
- [ ] MongoDB 当前运行正常
- [ ] 复制集其他节点健康
- [ ] 变配后 /mnt/data 挂载成功
- [ ] 数据目录完整无损
- [ ] MongoDB 进程运行正常
- [ ] 数据库可正常访问
- [ ] 复制集状态正常

---

## 注意事项

⚠️ **修改 fstab 不影响当前运行**：只影响重启后的自动挂载  
⚠️ **变配会停机**：MongoDB 会短暂不可用（5-15分钟）  
⚠️ **数据不会丢失**：只是设备名变化，数据依然在磁盘上  
⚠️ **建议操作时间**：业务低峰期，DBA 待命